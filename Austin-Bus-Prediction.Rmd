---
title: "Bus Ridership Prediction in Austin, TX"
author: "Hanyong Xu, Jia Yuan, Yibing Zheng"
date: "12/2019"
output:
  html_document:
    toc: TRUE
    toc_float: true
    code_folding: hide
    prettydoc::html_pretty:
    theme: cosmo
    highlight: tango
---
<style>
.superbigimage{
overflow-x:scroll;
white-space: nowrap;
}
.superbigimage img{
max-width: none;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	fig.align = "center",
	message = FALSE,
	warning = FALSE,
	cache = FALSE,
	results = FALSE
)
options(scipen=99)
```

# 1. Introduction

## Background

Cap Remap comes from a 10-year transit plan: Connections 2025. It aims to adjust the transit network according to internal analysis about what works the best and community outreach. It also aims to improve the east-west connection. 

Passengers can buy their passes on the CapMetro app directly. The new network will cause more transfers to passengers but overall less waiting time. A single ride pass is \$1.25. For a Day-Pass, it is \$2.5 which allows a passenger to ride for unlimited times in 24 hours. They also have options for 7-day passes or monthly pass.

## Overview

- More frequent, more reliable and better connected
- Triple the number of bus routes that operate every 15min
- Make sure the frequency meets the need on weekends
- Link to [High-Frequency Service Map](https://capmetro.org/uploadedFiles/New2016/Plan_Your_Trip/Schedules_and_Maps/high-frequency-system-map.pdf): shows the routes operate every 15min

# Exploratory Analysis

```{r}
library(tidyverse)
library(sf)
library(QuantPsyc)
library(RSocrata)
library(viridis)
library(caret)
library(spatstat)
library(spdep)
library(FNN)
library(grid)
library(gridExtra)
library(knitr)
library(kableExtra)
library(tidycensus)
library(nnet)
library(reshape2)
library(class)
library(MASS)
library(dplyr)
library(tidyr)
library(lubridate)
library(plotly)
library(ggmap)
library(data.table)
library(gganimate)
library(corrplot)
library(stargazer)
library(tigris)
library(ckanr)
library(ggplot2)
```

```{r}
mapTheme <- function(base_size = 10) {
  theme(
    text = element_text(color = "black"),
    plot.title = element_text(size = 12,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    axis.title = element_blank(),
    strip.background = element_rect(fill = "white", color = "white"),
    strip.text.x = element_text(size = 8),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank()
  )
}

plotTheme <- theme(
  plot.title =element_text(size=12),
  plot.subtitle = element_text(size=8),
  plot.caption = element_text(size = 6),
  axis.text.x = element_text(size = 10, angle = 45, hjust = 1),
  axis.text.y = element_text(size = 10),
  axis.title.y = element_text(size = 10),
  # Set the entire chart region to blank
  panel.background=element_blank(),
  plot.background=element_blank(),
  axis.ticks=element_blank())

q5 <- function(variable) {as.factor(ntile(variable, 5))}
qBr <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],0),
                          c(.01,.2,.4,.6,.8), na.rm=T))
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]]), digits = 3),
                          c(.01,.2,.4,.6,.8), na.rm=T)
  }
}

plotTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle = element_text(face="italic"),
    plot.caption = element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),
    panel.grid.major = element_line("grey80", size = 0.1),
    panel.grid.minor = element_blank(),
    #panel.border = element_rect(colour = "black", fill=NA, size=2),
    strip.background = element_rect(fill = "grey80", color = "white"),
    strip.text = element_text(size=12),
    axis.title = element_text(size=12),
    axis.text = element_text(size=10),
    plot.background = element_blank(),
    legend.background = element_blank(),
    legend.title = element_text(colour = "black", face = "italic"),
    legend.text = element_text(colour = "black", face = "italic"),
    strip.text.x = element_text(size = 14)
  )
}
nn_function <- function(measureFrom,measureTo,k) {
  
  nn <-   
    FNN::get.knnx(measureTo, measureFrom, k)$nn.dist
  
  output <-
    as.data.frame(nn) %>%
    rownames_to_column(var = "thisPoint") %>%
    gather(points, point_distance, V1:ncol(.)) %>%
    arrange(as.numeric(thisPoint)) %>%
    group_by(thisPoint) %>%
    summarize(pointDistance = mean(point_distance)) %>%
    arrange(as.numeric(thisPoint)) %>% 
    dplyr::select(-thisPoint)
  
  return(output)  
}
```

## Ridership Overall Trend Using the Aggregate Data

Charts about stop-level ridership change before and after CapRemap
```{r}
data <- read.csv('C:/Users/HanyongXu/Documents/Me/grad/Spring_2020/MUSA801/Data/MUSA Data - Stop Ridership Aggregated.csv')

data = data %>% 
  rename(STOP_ID = Ã¯..STOP_ID,)

table(data$YEAR_ID)
data.y18 <- data %>%
  subset(data$YEAR_ID == "2018")

max(data.y18$AVERAGE_ON)
```

```{r}
as.numeric(data$STOP_ID)

data.y18$MONTH_ID <- factor( data.y18$MONTH_ID, levels = c( "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12") )
data.y.1 <- data.y18 %>%
  subset(data.y18$STOP_ID <= 1050 & data.y18$AVERAGE_ON <= 30)

summary(data.y18$AVERAGE_ON)
```

Import School District shapefile
```{r}
TrusteeDist <- 
  st_read("C:/Users/HanyongXu/Documents/Me/grad/Spring_2020/MUSA801/Data/Trustee_Boundaries/Trustee.shp")%>%
  st_transform(2278) 

ggplot()+
  geom_sf(data = TrusteeDist)

```

Join stops and school districts
```{r}
data.sf <-
  data %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326, agr = "constant") %>%
  st_transform(2278)

Austin.sf<-
  data.sf%>%
  st_join(dplyr::select(TrusteeDist,TRUSTEE))

data.y.Trustee18 <- Austin.sf %>%
  subset(Austin.sf$YEAR_ID == "2018")

```

```{r}
data.y.Trustee18$MONTH_ID <- factor(data.y.Trustee18$MONTH_ID, levels = c( "1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "11", "12") )

plot.Trustees <- 
  as.data.frame(data.y.Trustee18) %>%
  group_by(TRUSTEE, MONTH_ID) %>% 
   summarize(BOARD_Count = sum(AVERAGE_ON)) %>%
    ggplot(aes(MONTH_ID,BOARD_Count)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~TRUSTEE, scales="free", ncol=3) +
      ylim(0,32000) +
      labs(title="Average Daily Ridership by Independent School District in Austin",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership in the District")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.Trustees
```

Making charts for Stops in TrusteeDistrict 1
```{r}
data.y.18.S1 <- data.y.Trustee18 %>%
  subset(data.y.Trustee18$TRUSTEE == "1")
summary(data.y.18.S1$AVERAGE_ON)


plot.S1.0 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID <= 667) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,30) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.0

```

```{r}
plot.S1.1 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 667 &STOP_ID <= 898) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,30) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.1

```


```{r}
plot.S1.1.1 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 898 &STOP_ID <= 1094) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,30) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.1.1

```



```{r}
plot.S1.2 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 1094 & STOP_ID <= 1123) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,20) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.2
```
```{r}
plot.S1.3 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 1123 & STOP_ID <= 1141) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,100) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.3
```
```{r}
plot.S1.4 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 1141 & STOP_ID <= 1324) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,200) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.4
```
```{r}
plot.S1.5 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 1324 & STOP_ID <= 1339) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,101) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.5
```
```{r}
plot.S1.6 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 1339 & STOP_ID <= 1396) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,135) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.6
```
```{r}
plot.S1.7 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 1396 & STOP_ID <= 1579) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,135) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.7
```
```{r}
plot.S1.8 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 1579 & STOP_ID <= 1598) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,110) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.8
```
```{r}
plot.S1.9 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 1598 & STOP_ID <= 1621) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,355) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.9
```
```{r}
plot.S1.10 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 1621 & STOP_ID <= 1643) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,90) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.10
```
```{r}
plot.S1.11 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 1643 & STOP_ID <= 2024) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,60) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.11
```
```{r}
plot.S1.12 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 2024 & STOP_ID <= 2065) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,25) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.12
```
```{r}
plot.S1.13 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 2065 & STOP_ID <= 2296) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,60) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.13
```
```{r}
plot.S1.14 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 2296 & STOP_ID <= 2396) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,100) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.14
```
```{r}
plot.S1.15 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 2396 & STOP_ID <= 2456) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,50) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.15
```
```{r}
plot.S1.16 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 2456 & STOP_ID <= 2886) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,100) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.16
```
```{r}
plot.S1.17 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 2886 & STOP_ID <= 3296) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,100) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.17
```
```{r}
plot.S1.18 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 3296 & STOP_ID <= 3731) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,100) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.18
```
```{r}
plot.S1.19 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 3731 & STOP_ID <= 4192) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,100) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.19
```
```{r}
plot.S1.3931 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID == 3931) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,1500) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.3931
```
```{r}
plot.S1.20 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 4192 & STOP_ID <= 4613) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,100) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.20
```
```{r}
plot.S1.21 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 4613 & STOP_ID <= 4723) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,200) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.21
```
```{r}
plot.S1.22 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 4723 & STOP_ID <= 4933) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,100) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.22
```
```{r}
plot.S1.23 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 4933 & STOP_ID <= 5131) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,120) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.23
```
```{r}
plot.S1.24 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 5131 & STOP_ID <= 5404) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,75) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.24
```
```{r}
plot.S1.25 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 5404 & STOP_ID <= 5506) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,75) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.25
```
```{r}
plot.S1.26 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 5506 & STOP_ID <= 5617) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,100) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.26
```
```{r}
plot.S1.27 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 5617 & STOP_ID <= 5782) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,120) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.27
```
```{r}
plot.S1.28 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 5782 & STOP_ID <= 5915) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,100) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.28
```
```{r}
plot.S1.29 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 5915 & STOP_ID <= 6296) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,250) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.29
```
```{r}
plot.S1.30 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 6296 | STOP_ID <= 657) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,100) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.30
```
```{r}
plot.S1.31 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 657 & STOP_ID <= 673) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,50) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.31
```
```{r}
plot.S1.32 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 673 & STOP_ID <= 898) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,50) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.32
```
```{r}
plot.S1.33 <- 
  as.data.frame(data.y.18.S1) %>% 
  filter(STOP_ID > 898 & STOP_ID <= 913) %>%
  group_by(STOP_ID) %>% 
    ggplot(aes(x= MONTH_ID, y=AVERAGE_ON, group = 1)) + 
      geom_point() +
      plotTheme() +
      facet_wrap(~STOP_ID, scales="free", ncol=5) +
      ylim(0,50) +
      labs(title="Average Daily Ridership by Stop in Austin IDS1",
           subtitle="CapRemap Redesign Implemented Month in Blue", x="Month", y="Average Daily Ridership")+ 
      geom_vline(xintercept = 6, color = "blue")

plot.S1.33
```

## Correlation Between Variables Using Aggregate Data

```{r}
agg <- read.csv('C:/Users/HanyongXu/Documents/Me/grad/Spring_2020/MUSA801/Data/MUSA Data - Stop Ridership Aggregated.csv')
disagg <- read.csv('C:/Users/HanyongXu/Documents/Me/grad/Spring_2020/MUSA801/Data/MUSA Disagregated Data Sample 01-06-2020 to 01-10-2020.csv')
austin <- st_read('https://data.austintexas.gov/api/geospatial/3pzb-6mbr?method=export&format=GeoJSON')

agg = agg %>% 
  rename(STOP_ID = Ã¯..STOP_ID,)
disagg = disagg %>% 
  rename(LOAD_NUM = Ã¯..LOAD_NUM,)
```

```{r}
austin <- austin%>%
  st_transform(32140)

#turn dataframe into spacitial object
agg_sf <- agg%>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326)%>%
  st_transform(32140)
```

divide agg_sf data into before and after capremap
```{r}
agg_before_sf <- agg_sf%>%
  filter(YEAR_ID == 2017 | (YEAR_ID == 2018 & MONTH_ID < 6))%>%
  group_by(STOP_ID)%>%
  summarise(avg_on = mean(AVERAGE_ON),
            avg_trips = mean(TRIPS))%>%
  mutate(ratio = avg_on / avg_trips)
```

```{r}
agg_after_sf <- agg_sf%>%
  filter(YEAR_ID == 2019 | (YEAR_ID == 2018 & MONTH_ID > 5))%>%
  group_by(STOP_ID)%>%
  summarise(avg_on = mean(AVERAGE_ON),
            avg_trips = mean(TRIPS))%>%
  mutate(ratio = avg_on / avg_trips)
```

scatterplot of ridership vs. number of trips per weekday
```{r}
Before_scatter <- ggplot()+
  geom_point(data = agg_before_sf, aes(x=avg_trips, y=avg_on, color = STOP_ID))+
  labs(title = "Ridership vs. Number of Trips",
       subtitle = "Before CapRemap",
       xlab = "Average Ridership",
       ylab = "Average Trips")

```
```{r}
After_scatter <-  ggplot()+
  geom_point(data = agg_after_sf, aes(x=avg_trips, y=avg_on, color = STOP_ID))+
  labs(title = "Ridership vs. Number of Trips",
       subtitle = "After CapRemap",
       xlab = "Average Ridership",
       ylab = "Average Trips")

Scatterplots <- grid.arrange(Before_scatter,After_scatter,ncol = 2)
```

## Mapping the Stops by Ridership Using the Aggregate Data

doesn't show clear patterns when plotting all the stops
```{r}
ggplot()+
  geom_sf(data=TrusteeDist)+
  #geom_sf(mapping = aes(), data = austin)+
  geom_sf(mapping = aes(color = ratio), data = agg_before_sf, size = 1)+
  scale_colour_gradient(low = "light blue", high = "darkblue")
```

below 25% as low ridership whereas higher than 75% as high ridership
```{r}
quantile(agg_before_sf$ratio)
quantile(agg_after_sf$ratio)

Low_before <- ggplot(data=TrusteeDist)+
  geom_sf(fill = "light grey")+
  geom_sf(data = subset(agg_before_sf, ratio<0.06505824), color = "darkblue")+
  labs(title = "Austin Bus Stops Ridership",
       subtitle = "Low ridership stops before CapRemap")
Low_after <- ggplot(data=TrusteeDist)+
  geom_sf(fill = "light grey")+
  geom_sf(data = subset(agg_after_sf, ratio<0.03767514), color = "darkblue")+
  labs(title = "Austin Bus Stops Ridership",
       subtitle = "Low ridership stops after CapRemap")

Low_Compare <- grid.arrange(Low_before, Low_after, ncol = 2)
```

```{r}
High_before <- ggplot(data=TrusteeDist)+
  geom_sf(fill = "light grey")+
  geom_sf(data = subset(agg_before_sf, ratio>0.43755896), color = "darkblue")+
  labs(title = "Austin Bus Stops Ridership",
       subtitle = "Low ridership stops before CapRemap")

High_after <- ggplot(data=TrusteeDist)+
  geom_sf(fill = "light grey")+
  geom_sf(data = subset(agg_after_sf, ratio>0.41095547), color = "darkblue")+
  labs(title = "Austin Bus Stops Ridership",
       subtitle = "Low ridership stops after CapRemap")

High_Compare <- grid.arrange(High_before, High_after, ncol = 2)

```

```{r}
Zero_before <- ggplot(data=TrusteeDist)+
  geom_sf(fill = "light grey")+
  geom_sf(data = subset(agg_before_sf, ratio==0), color = "darkblue")+
  labs(title = "Austin Bus Stops Ridership",
       subtitle = "Stops without Any Ridership before CapRemap")

Zero_after <- ggplot(data=TrusteeDist)+
  geom_sf(fill = "light grey")+
  geom_sf(data = subset(agg_after_sf, ratio==0), color = "darkblue")+
  labs(title = "Austin Bus Stops Ridership",
       subtitle = "Stops without Any Ridership before CapRemap")

Zero_Compare <- grid.arrange(Zero_before, Zero_after, ncol = 2)

```

Mapping ridership in May
```{r}
q5 <- function(variable) {as.factor(ntile(variable, 5))}

qBr <- function(df, variable, rnd) {
  if (missing(rnd)) {
    as.character(quantile(round(df[[variable]],0),
                          c(.01,.2,.4,.6,.8), na.rm=T))
  } else if (rnd == FALSE | rnd == F) {
    as.character(formatC(quantile(df[[variable]]), digits = 3),
                 c(.01,.2,.4,.6,.8), na.rm=T)
  }
}

palette5 <- c("#FA7800","#C48C04","#8FA108","#5AB60C","#25CB10")

mapTheme <- function(base_size = 12) {
  theme(
    text = element_text( color = "black"),
    plot.title = element_text(size = 14,colour = "black"),
    plot.subtitle=element_text(face="italic"),
    plot.caption=element_text(hjust=0),
    axis.ticks = element_blank(),
    panel.background = element_blank(),axis.title = element_blank(),
    axis.text = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(colour = "black", fill=NA, size=2)
  )
}
data.y.18.5 <- data.y18 %>%
  subset(data.y18$MONTH_ID == 5)

data.y.18.5.sf <-
  data.y.18.5 %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326, agr = "constant") %>%
  st_transform(2278)

ggplot()+
  geom_sf(data=TrusteeDist,fill="grey20")+
  geom_sf(data=data.y.18.5.sf,aes(colour=q5(AVERAGE_ON)),show.legend = "point",size = .75)+
  scale_color_manual(values=palette5,
                     labels=qBr(data.y.18.5.sf,"AVERAGE_ON"),
                     name="Quintile\nBreaks")+
  labs(title="Ridership in May, Austin")+
  mapTheme()
```

Mapping ridership in June
```{r}
data.y.18.6 <- data.y18 %>%
  subset(data.y18$MONTH_ID == 6)

data.y.18.6.sf <-
  data.y.18.6 %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326, agr = "constant") %>%
  st_transform(2278)

ggplot()+
  geom_sf(data=TrusteeDist,fill="grey20")+
  geom_sf(data=data.y.18.6.sf,aes(colour=q5(AVERAGE_ON)),show.legend = "point",size = .75)+
  scale_color_manual(values=palette5,
                     labels=qBr(data.y.18.6.sf,"AVERAGE_ON"),
                     name="Quintile\nBreaks")+
  labs(title="Ridership in June, Austin")+
  mapTheme()
```

## Finding the Hotlines and Coldlines Using Disaggregate Data

```{r}
nhood = st_read('https://data.austintexas.gov/resource/nz5f-3t2e.geojson')
```

overall: 
find the hot lines by max passenger load
```{r}
hotlines_x = disagg %>%
  group_by(ROUTE) %>%
  summarise(max_load = max(PSGR_LOAD)) %>%
  arrange(desc(max_load)) %>%
  top_n(5) %>%
  select(ROUTE)
```

find the hot lines by mean passenger load (did not use this for plotting)
```{r}
disagg %>%
  group_by(ROUTE) %>%
  summarise(mean_load = mean(PSGR_LOAD)) %>%
  arrange(desc(mean_load)) %>%
  top_n(5) %>%
  select(ROUTE)
```

plot it 
```{r}
disagg %>%
  filter(ROUTE %in% hotlines_x$ROUTE) %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326, agr = "constant") %>%
  st_transform(2278) %>%
  group_by(STOP_ID) %>%
  summarise(mean_stop_load = mean(PSGR_LOAD)) %>%
  ggplot() +
  geom_sf(data = nhood) +
  geom_sf( size = 0.8, aes(color = mean_stop_load))+
  labs(title="Five Most Popular Bus Routes (Hot Lines) in Austin")

```

```{r}
disagg %>%
  filter(ROUTE %in% hotlines_x$ROUTE) %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326, agr = "constant") %>%
  st_transform(2278) %>%
  group_by(STOP_ID) %>%
  filter(PSGR_LOAD == max(PSGR_LOAD)) %>%
  ggplot() +
  geom_sf(data = nhood) +
  geom_sf(aes(color = factor(ROUTE), size = PSGR_LOAD, alpha = 0.1), show.legend = "point") +
  scale_size(range = c(0.5, 2.5)) +
  labs(title="Five Most Popular Bus Routes with respect to Passenger Load")
```

passenger miles traveled
```{r}
disagg %>%
  filter(ROUTE %in% hotlines_x$ROUTE) %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326, agr = "constant") %>%
  st_transform(2278) %>%
  group_by(STOP_ID) %>%
  filter(PSGR_LOAD == max(PSGR_LOAD)) %>%
  ggplot() +
  geom_sf(data = nhood) +
  geom_sf(aes(color = factor(ROUTE), size = PSGR_MILES, alpha = 0.1), show.legend = "point") +
  scale_size(range = c(0.5, 5)) +
  labs(title="Five Most Popular Bus Routes in Austin with respect to PMT")
```

use passenger hours to represent durations
```{r}
disagg %>%
  filter(ROUTE %in% hotlines_x$ROUTE) %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326, agr = "constant") %>%
  st_transform(2278) %>%
  group_by(STOP_ID) %>%
  filter(PSGR_LOAD == max(PSGR_LOAD)) %>%
  ggplot() +
  geom_sf(data = nhood) +
  geom_sf(aes(color = factor(ROUTE), size = PSGR_HOURS, alpha = 0.1), show.legend = "point") +
  scale_size(range = c(0.5, 5)) +
  labs(title="Five Most Popular Bus Routes in Austin with respect to PHT")
```

find the cold lines by max passenger load
```{r}
coldlines_x = disagg %>%
  group_by(ROUTE) %>%
  summarise(max_load = max(PSGR_LOAD)) %>%
  arrange(max_load) %>%
  top_n(-4) %>%
  select(ROUTE)
```

find the cold lines by mean passenger load
```{r}
disagg %>%
  group_by(ROUTE) %>%
  summarise(mean_load = mean(PSGR_LOAD)) %>%
  arrange(mean_load) %>%
  top_n(-5) %>%
  select(ROUTE)
```

plot it 
```{r}
disagg %>%
  filter(ROUTE %in% coldlines_x$ROUTE) %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326, agr = "constant") %>%
  st_transform(2278) %>%
  group_by(STOP_ID) %>%
  summarise(mean_stop_load = mean(PSGR_LOAD)) %>%
  ggplot() +
  geom_sf(data = nhood) +
  geom_sf(size = 0.8, aes(color = mean_stop_load)) +
  labs(title="Five least Popular Bus Routes (Cold Lines) in Austin")
```

```{r}
disagg %>%
  filter(ROUTE %in% coldlines_x$ROUTE) %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326, agr = "constant") %>%
  st_transform(2278) %>%
  group_by(STOP_ID) %>%
  filter(PSGR_LOAD == max(PSGR_LOAD)) %>%
  ggplot() +
  geom_sf(data = nhood) +
  geom_sf(aes(color = factor(ROUTE), size = PSGR_LOAD, alpha = 0.1), show.legend = "point") +
  scale_size(range = c(0.5, 2.5)) +
  labs(title="Four least Popular Bus Routes (Cold Lines) in Austin")

```

passenger miles traveled
```{r}
disagg %>%
  filter(ROUTE %in% coldlines_x$ROUTE) %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326, agr = "constant") %>%
  st_transform(2278) %>%
  group_by(STOP_ID) %>%
  filter(PSGR_LOAD == max(PSGR_LOAD)) %>%
  ggplot() +
  geom_sf(data = nhood) +
  geom_sf(aes(color = factor(ROUTE), size = PSGR_MILES, alpha = 0.1), show.legend = "point") +
  scale_size(range = c(0.5, 5)) +
  labs(title="Four least Popular Bus Routes (Cold Lines) in Austin")
```

use passenger hours to represent durations
```{r}
disagg %>%
  filter(ROUTE %in% coldlines_x$ROUTE) %>%
  st_as_sf(coords = c("LONGITUDE", "LATITUDE"), crs = 4326, agr = "constant") %>%
  st_transform(2278) %>%
  group_by(STOP_ID) %>%
  filter(PSGR_LOAD == max(PSGR_LOAD)) %>%
  ggplot() +
  geom_sf(data = nhood) +
  geom_sf(aes(color = factor(ROUTE), size = PSGR_HOURS, alpha = 0.1), show.legend = "point") +
  scale_size(range = c(0.5, 5)) +
  labs(title="Four least Popular Bus Routes (Cold Lines) in Austin")
```

## Find Operation Pattern Using Disaggregate Data

check the highest frequency for hot lines
```{r}
disagg %>%
  group_by(ROUTE) %>%
  summarise(freq = n_distinct(TRIP)) %>%
  arrange(desc(freq))%>%
  top_n(15) %>%
  ggplot() +
  geom_bar(aes(x= factor(ROUTE), y= freq, fill=factor(ROUTE), alpha = 0.5),stat="identity") +
  labs(title="Weekly Bus Routes with High Frequency in Austin")
```

```{r eval=FALSE, include=FALSE}
disagg %>%
  group_by(ROUTE) %>%
  summarise(freq = n_distinct(TRIP), max_load = max(PSGR_LOAD)) %>%
  arrange(freq)%>%
  top_n(15) %>%
  ggplot() +
  geom_bar(aes(x= factor(ROUTE), y= freq, fill=factor(ROUTE), alpha = 0.3),stat="identity") +
  geom_bar(aes(x= factor(ROUTE), y= max_load, alpha = 0.3),stat="identity") +
  labs(title="Bus Routes with High Frequency in Austin")
```

time of large load
```{r}
disagg_x = disagg %>%
  mutate(datetime = parse_date_time(ACT_STOP_TIME, '%m/%d/%Y %H:%M'),
         interval60 = floor_date(ymd_hms(datetime), unit = "hour"),
         interval15 = floor_date(ymd_hms(datetime), unit = "15 mins"))
```

```{r eval=FALSE, include=FALSE}
ggplot(disagg_x %>% 
         mutate(hour = hour(datetime)) %>% 
         filter(PSGR_LOAD < quantile(PSGR_LOAD, 0.062)), aes(hour, color = factor(ROUTE)))+
  geom_freqpoly(binwidth = 1)+
  labs(title="Hourly Bus Stop Count for Low Occupancy") +
  plotTheme()
```

```{r}
ggplot(disagg_x %>% 
         mutate(hour = hour(datetime)) %>% 
         filter(PSGR_LOAD > quantile(PSGR_LOAD, 0.997)), aes(hour, color = factor(ROUTE)))+
  geom_freqpoly(binwidth = 1)+
  labs(title="Hourly Bus Stop Count for High Occupancy") +
  plotTheme()
```

```{r eval=FALSE, include=FALSE}
ggplot(disagg_x %>% 
         mutate(hour = hour(datetime)), aes(hour, color = factor(ROUTE)))+
  geom_freqpoly(binwidth = 1)+
  labs(title="Hourly Bus Stop Count for All Shifts") +
  plotTheme()

ggplot(disagg_x %>% 
         mutate(minu = strftime(datetime, format="%H:%M")) %>% 
         filter(PSGR_LOAD > quantile(PSGR_LOAD, 0.999)), aes(minu, PSGR_LOAD, colour = factor(ROUTE))) +
  geom_line()
```






